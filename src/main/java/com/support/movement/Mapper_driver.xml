<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.support.movement.DriverDAO">

	<select id="getDriverDTO" parameterType="String"
		resultType="com.support.movement.DriverDTO">
		select
		driver_no||'' as "driver_no",
		driver_id as "id",
		driver_pwd as "pwd1",
		driver_name as "name",
		driver_gender as "gender",
		substr(driver_jumin_num,1,6) as "jumin_num1",
		substr(driver_jumin_num,7,7) as "jumin_num2",
		driver_postal_code||'' as "postal_code",
		driver_road_addr as "road_addr",
		driver_jibun_addr as "jibun_addr",
		driver_detail_addr as "detail_addr",
		driver_phone as "phone",
		driver_email as "email",
		driver_license_number as "driver_license_number",
		admission_code as "admission_code"

		from driver
		where driver_id = #{id}

	</select>

	<select id="getDriveList" parameterType="com.support.movement.DriveSearchDTO" resultType="hashmap">
		<if test="selectPageNo>0">
		select 
			*
		from (select zzz.*, rownum||'' RNUM from (
		</if>
		select
			RESERVE_APPLY_CAR_NUMBER as "reserve_apply_car_number"
			,to_char( RESERVATION_DATE, 'YYYY-MM-DD' ) as "reservation_date"
			,START_POINT_LONGITUDE as "start_point_longitude"
			,START_POINT_LATITUDE as "start_point_latitude"
			,END_POINT_LONGITUDE as "end_point_longitude"
			,END_POINT_LATITUDE as "end_point_latitude"
			,CAR_NUMBER as "car_number"
			,RESERVE_COUNT||'' as "reserve_count"
			,USER_NO as "user_no"
			,DRIVER_NO as "driver_no"
			,START_ROAD_ADDR as "start_road_addr"
			,START_DETAIL_ADDR as "start_detail_addr"
			,END_ROAD_ADDR as "end_road_addr"
			,END_DETAIL_ADDR as "end_detail_addr"
			,to_char(DRIVE_FINISH_TIME, 'hh24:mi:ss') AS "drive_finish_time"
			,to_char(DRIVE_START_TIME, 'hh24:mi:ss') AS "drive_start_time"
			,DRIVE_DISTANCE AS "drive_distance"
	
		from RESERVE_APPLY_CAR
		where driver_no=(select driver_no from driver where driver_id=#{id}) and RESERVE_STATUS_CODE='5'
		 <if test="selectPageNo>0">	
		<![CDATA[
		 ) zzz)  where RNUM>= ${selectPageNo} * 5 - 5+1 and RNUM <= ${selectPageNo} * 5
		 ]]>
		 </if>
	</select>
	
	
	<select id="getDriveListAllCnt" parameterType="com.support.movement.DriveSearchDTO" resultType="int">		
		select 
			count(*)	
		from RESERVE_APPLY_CAR
		where driver_no=(select driver_no from driver where driver_id=#{id}) and RESERVE_STATUS_CODE='5'
	</select>
	<select id="getDriverCarInfo" parameterType="String"
      resultType="com.support.movement.CarDTO">
      select
      DISTINCT(ci.car_number)||'' as "car_number"
      ,CAR_YEAR||'' as "car_year"
      ,  case when 
             (
                select 
                   (ci.car_distance -DISTANCE) 
                from reserve_apply_car rac 
                where rac.car_number=( select car_number from car_info where car_driver=(select driver_no from driver where driver_id=#{id} ) )
               ) &lt;=50000 
            then (50000-ci.car_distance +DISTANCE)||'' 
             else '차량정기정검필요' 
         end "car_distance"
      , (select CAR_TYPE from code_car where CAR_CODE=(select car_code from car_info where car_driver=(select driver_no from driver where driver_id=#{id}) ) )||'' as "car_code"
      from car_info ci  ,
           (
            select  ci.CAR_NUMBER, decode( nvl(cmi.CNT,0), 0 , 0,
                                (select nvl(cmi.car_distance , 0) from car_maintance_info cmi, car_info ci
                                        where to_char(cmi.car_maintance_date,'YYYYMMDD')=ANY(select max(to_char(car_maintance_date,'YYYYMMDD')) from car_maintance_info) and cmi.car_maintance_code='1' and cmi.car_number=ci.CAR_NUMBER
                                )
                      )  "DISTANCE"
            from car_info ci,
               (select car_number, car_distance, count(*) "CNT"
                from car_maintance_info
                where car_maintance_code='1' and to_char(car_maintance_date,'YYYYMMDD')=ANY(select max(to_char(car_maintance_date,'YYYYMMDD')) from car_maintance_info)
                group by car_number, car_distance
               ) cmi
           where ci.CAR_NUMBER=cmi.CAR_NUMBER(+)
      
            ) "REPAIR"
      
       where 1=1 and REPAIR.car_number=ci.CAR_NUMBER
       and car_driver=(select driver_no from driver where driver_id=#{id})
   </select>
	
	<select id="getDriverUserReresveListAllCnt" parameterType="com.support.movement.ReserveSearchDTO" resultType="int">
		select 
			count(*)	
		from RESERVE_APPLY_CAR
		where driver_no=(select driver_no from driver where driver_id=#{id}) and RESERVE_STATUS_CODE='2'
	</select>
	
	<select id="getDriverUserReresveList" parameterType="com.support.movement.ReserveSearchDTO" resultType="hashmap">
		<if test="selectPageNo>0">
		select 
			*
		from (select zzz.*, rownum||'' RNUM from (
		</if>
		select
			RESERVE_APPLY_CAR_NUMBER as "reserve_apply_car_number"
			,to_char( RESERVATION_DATE, 'YYYY-MM-DD' ) as "reservation_date"
			,RESERVE_COUNT as "reserve_count"
			,USER_NO as "user_no"
			            ,(select user_name from DISABILITY_USER 
                        where user_no=(select user_no from RESERVE_APPLY_CAR where driver_no=(select driver_no from driver where driver_id=#{id}) 
                        and reserve_apply_car_number=(select reserve_apply_car_number from RESERVE_ACCEPT_LIST where driver_no=(select driver_no from driver where driver_id=#{id}) and RESERVE_STATUS_CODE='2')    
                    )
              ) as "user_name"
			,START_ROAD_ADDR as "start_road_addr"
			,START_DETAIL_ADDR as "start_detail_addr"
			,END_ROAD_ADDR as "end_road_addr"
			,END_DETAIL_ADDR as "end_detail_addr"
			,to_char( RESERVATION_DATE, 'HH24:MI:SS' ) as "reservation_hour"
		from RESERVE_APPLY_CAR 
		where driver_no=(select driver_no from driver where driver_id=#{id}) and RESERVE_STATUS_CODE='2'
		 <if test="selectPageNo>0">	
		<![CDATA[
		 ) zzz)  where RNUM>= ${selectPageNo} * 5 - 5+1 and RNUM <= ${selectPageNo} * 5
		 ]]>
		 </if>
	</select>
	
	<select id="getDriverGrade" parameterType="int" resultType="com.support.movement.ReviewDTO">
		select
            r.review_no||'' as "review_no",
            r.reserve_apply_car_number||'' as "reserve_apply_car_number",
            r.review_score||'' as "review_score",
            r.review_content||'' as "review_content",
            to_char( r.review_date, 'yyyy-mm-dd' )||'' as "review_date",
            (select to_char(c.reservation_date,'yyyy-mm-dd hh24') from reserve_apply_car c where c.reserve_apply_car_number=r.reserve_apply_car_number)||'' as "reservation_date",
            (select u.user_name from disability_user u,reserve_apply_car c where c.user_no=u.user_no and  c.reserve_apply_car_number=r.reserve_apply_car_number)||'' as "user_name",
            (select c.end_road_addr from reserve_apply_car c where c.reserve_apply_car_number=r.reserve_apply_car_number)||'' as "end_road_addr",
            (select c.start_road_addr from reserve_apply_car c where c.reserve_apply_car_number=r.reserve_apply_car_number)||'' as "start_road_addr"
        from
            review  r
        where
            r.reserve_apply_car_number=#{reserve_apply_car_number}
            
			
	</select>
</mapper>
